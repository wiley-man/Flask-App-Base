# Flask Application Base

**Here’s a clean, battle-tested way to configure a Flask app for development, testing, and production using the app-factory pattern, config classes, and environment variables.**

## 1) Project layout

```text
flask-app-base/
├─ flaskapp/
|  ├─ templates/
|  |  ├─ base.html
|  |  ├─ index.html      # jinja2 template for home page (extends base)
|  |  └─ about.html      # example extra page (extends base)
|  ├─ static/
|  |  └─ css/
|  |     └─ qoutes.css
│  ├─ __init__.py        # app factory lives here
│  ├─ extensions.py      # db, migrate instances
│  ├─ routes.py
│  ├─ models.py
│  └─ config.py          # all configs in one place
├─ instance/             # machine-specific, not committed
|  ├─ dev.db             # lives here when using SQLite (generated by alembic)
│  └─ config.py          # optional local secrets/overrides
├─ migrate/              # flask migration (generated by alembic)
├─ .env                  # dev-only env vars (never in prod)
├─ .env.test             # test-only env vars
├─ wsgi.py               # for prod servers (gunicorn/uwsgi)
└─ tests/
   ├─ conftest.py
   ├─ test_home.py
   └─ test_example.py
```

## 2) Config classes (flaskapp/config.py)

```python
import os
from datetime import timedelta

BASE_DIR = os.path.abspath(os.path.dirname(__file__))
DEFAULT_DB = f"sqlite:///{os.path.join(BASE_DIR, '..', 'app.db')}"

class Config:
    SECRET_KEY = os.environ.get("SECRET_KEY", "dev-insecure")  # override in prod!
    SQLALCHEMY_DATABASE_URI = os.environ.get("DATABASE_URL", DEFAULT_DB)
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    SESSION_COOKIE_HTTPONLY = True
    REMEMBER_COOKIE_HTTPONLY = True
    PERMANENT_SESSION_LIFETIME = timedelta(days=7)
    # Logging level (can be overridden)
    LOG_LEVEL = os.environ.get("LOG_LEVEL", "INFO")

class DevelopmentConfig(Config):
    DEBUG = True
    # Helpful for dev: show Werkzeug debugger, etc.
    # Use a separate dev DB if you like
    SQLALCHEMY_DATABASE_URI = os.environ.get("DEV_DATABASE_URL", DEFAULT_DB)

class TestingConfig(Config):
    TESTING = True
    DEBUG = True
    # In-memory DB by default for isolation/speed
    SQLALCHEMY_DATABASE_URI = os.environ.get("TEST_DATABASE_URL", "sqlite:///:memory:")
    WTF_CSRF_ENABLED = False  # usually disabled for tests
    # Make cookies non-secure to avoid HTTPS requirement in tests
    SESSION_COOKIE_SECURE = False

class ProductionConfig(Config):
    DEBUG = False
    # Production must provide strong secrets + real DB
    SECRET_KEY = os.environ["SECRET_KEY"]      # crash early if missing
    SQLALCHEMY_DATABASE_URI = os.environ["DATABASE_URL"]
    SESSION_COOKIE_SECURE = True
    REMEMBER_COOKIE_SECURE = True
    # Example: stricter headers
    # SEND_FILE_MAX_AGE_DEFAULT = 31536000
```

## 3) App factory (flaskapp/__init__.py)

```python
import logging
import os
from flask import Flask
from .config import DevelopmentConfig, TestingConfig, ProductionConfig
from .routes import routes_bp # assume you have a blueprint
from .extensions import db, migrate
from .models import Quote

CONFIG_MAP = {
    "development": DevelopmentConfig,
    "testing": TestingConfig,
    "production": ProductionConfig,
}

def create_app(config_name: str | None = None) -> Flask:
    # Allow env var to choose config (default: development)
    config_name = config_name or os.getenv("FLASK_ENV_NAME", "development")

    app = Flask(__name__, instance_relative_config=True)
    os.makedirs(app.instance_path, exist_ok=True)

    # Base config from class
    app.config.from_object(CONFIG_MAP[config_name])

    # Optional: load instance/ config (ignored if missing)
    app.config.from_pyfile("config.py", silent=True)

    # Optional: allow an env var to point to a file with secrets
    # e.g., export YOURAPP_SETTINGS=/path/to/production.cfg
    app.config.from_envvar("YOURAPP_SETTINGS", silent=True)

    # ---- Extensions ----
    db.init_app(app)
    migrate.init_app(app, db)

    # Blueprints, extensions, CLI, etc.
    app.register_blueprint(routes_bp)

    _configure_logging(app)

    # ---- CLI: seed data ----
    @app.cli.command("seed-quotes")
    def seed_quotes():
        """Insert a few sample quotes (idempotent-ish)."""
        samples = [
            Quote(text="Simplicity is the soul of efficiency", author="Austin Freeman"),
            Quote(text="Programs must be written for people to read", author="Harold Abelson"),
            Quote(text="Talk is cheap. Show me the code", author="Linus Torvalds"),
            Quote(text="Any sufficiently advanced technology is indistinguishable from magic", author="Arthur C. Clarke"),
            Quote(text="The best way to predict the future is to invent it", author="Alan Kay"),
            Quote(text="Stay hungry, stay foolish.", author="Steve Jobs"),
            Quote(text="Growth and comfort do not coexist", author="Ginni Rommetty"),
            Quote(text="Technology is best when it brings people together", author="Matt Mullenweg"),
            Quote(text="The technology you use impresses no one. The experience you create with it is everything", author="Sean Gerety"),
            Quote(text="The advance of technology is based on making it fit in so that you don’t really even notice it, so it’s part of everyday life.", author="Bill Gates"),
            Quote(text="If you’re offered a seat on a rocket ship, don’t ask what seat.", author="Sheryl Sandberg"),
            Quote(text="You can focus on things that are barriers or you can focus on scaling the wall or redefining the problem", author="Tim Cook"),
            Quote(text="Don’t be afraid to change the model", author="Reed Hastings"),
            Quote(text="Never trust a computer you can’t throw out a window", author="Steven Wozniak"),
            Quote(text="Never let a computer know you’re in a hurry", author="author unknown"),
            Quote(text="Hardware: The parts of a computer system that can be kicked", author="Jeff Pesis"),
            Quote(text="Once a new technology rolls over you, if you’re not part of the steamroller, you’re part of the road.", author="Stewart Brand"),
            Quote(text="If it keeps up, man will atrophy all his limbs but the push-button finger.", author="Frank Lloyd Wright"),
            Quote(text="Technology is ruled by two types of people: those who manage what they do not understand, and those who understand what they do not manage.", author="Make Trout"),
            Quote(text="Technology is like a fish. The longer it stays on the shelf, the less desirable it becomes.", author="Andrew Heller"),
            Quote(text="I just invent. Then I wait until man comes around to needing what I’ve invented", author="R. Buckminster Fuller"),
            Quote(text="Computers have lots of memory but no imagination", author="author unknown"),
            Quote(text="People who smile while they are alone used to be called insane until we invented smartphones and social media", author="Mokokoma Mokhonoana"),
            Quote(text="I won’t be impressed with technology until I can download food", author="author unknown"),
            Quote(text="Life was much easier when Apple and Blackberry were just fruits", author="author unknown"),
        ]
        # Only add if table is empty
        if Quote.query.count() == 0:
            db.session.add_all(samples)
            db.session.commit()
            print("Seeded sample quotes.")
        else:
            print("Quotes already present; skipping seed.")

    return app

def _configure_logging(app: Flask) -> None:
    # Simple per-environment logging
    level = getattr(logging, app.config.get("LOG_LEVEL", "INFO").upper(), logging.INFO)
    handler = logging.StreamHandler()
    handler.setLevel(level)
    fmt = "[%(asctime)s] %(levelname)s in %(module)s: %(message)s"
    handler.setFormatter(logging.Formatter(fmt))
    app.logger.setLevel(level)
    if not any(isinstance(h, logging.StreamHandler) for h in app.logger.handlers):
        app.logger.addHandler(handler)
```

Why FLASK_ENV_NAME?

Flask 3.x removed FLASK_ENV. You control debug mode with FLASK_DEBUG=1, and you choose your config class yourself (here via 

FLASK_ENV_NAME=development|testing|production).

## 4) Instance config (optional)

Anything in instance/config.py is ignored by git and loads after your class config—great for per-host overrides:

\# instance/config.py

```ini
SECRET_KEY = "dev-machine-secret"
```

## 5) Adding SQLAlchemy and migrate to flask

- uses Flask-SQLAlchemy for models
- wires up Flask-Migrate for schema changes
- replaces the raw sqlite3 calls with ORM queries
- keeps your blueprint home route that shows a random “Comment of the Day”

## 6) flaskapp/extensions.py

```python
# flaskapp/extensions.py
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

db = SQLAlchemy()
migrate = Migrate()
```

## 7) flaskapp/models.py

```python
# flaskapp/models.py
from .extensions import db

class Quote(db.Model):
    __tablename__ = "quotes"

    id = db.Column(db.Integer, primary_key=True)
    text = db.Column(db.Text, nullable=False)
    author = db.Column(db.String(255))

```

## 8) flaskapp/routes.py

```python
# flaskapp/routes.py
from flask import Blueprint, render_template
from sqlalchemy import func
from .models import Quote

routes_bp = Blueprint("routes", __name__)

@routes_bp.route("/")
def home():
    row = Quote.query.order_by(func.random()).first()
    if row is None:
        quote, author = "No quotes yet. Run: flask db upgrade && flask seed-quotes", None
    else:
        quote, author = row.text, (row.author or None)
    return render_template("index.html", quote=quote, author=author)
```

Note: func.random() works on SQLite & Postgres.

On MySQL/MariaDB, Alembic/SQLAlchemy will translate to RAND() automatically.

## 9) adding html templates and css using jinja2 inheretance

### flaskapp/templates/base.html

This is the master layout. It sets typography, includes your CSS, and exposes blocks for child pages to fill.

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{% block title %}My Flask App{% endblock %}</title>

    {% block head_fonts %}
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    {% endblock %}

    <link rel="stylesheet" href="{{ url_for('static', filename='css/quotes.css') }}">

    {% block head_extra %}{% endblock %}
  </head>
  <body>
    <header class="site-header">
      <nav class="nav">
        <a class="brand" href="{{ url_for('routes.home') }}">✨ Comments</a>
        <div class="spacer"></div>
        <a class="nav-link {% if request.endpoint == 'routes.home' %}active{% endif %}"
           href="{{ url_for('routes.home') }}">Home</a>
        <a class="nav-link {% if request.endpoint == 'routes.about' %}active{% endif %}"
           href="{{ url_for('routes.about') }}">About</a>
      </nav>
    </header>

    <main class="wrap">
      {% block content %}{% endblock %}
    </main>

    <footer class="site-footer">
      <small>© {{ config.get('APP_NAME', 'This App') }} · Powered by Flask</small>
    </footer>

    {% block scripts %}{% endblock %}
  </body>
</html>
```

### flaskapp/templates/about.html

```html
{% extends "base.html" %}

{% block title %}About{% endblock %}

{% block content %}
  <section class="quote-card" aria-label="About this app">
    <div class="badge">About</div>
    <p class="quote-text">
      This demo shows a home page that pulls a random quote from the database using SQLAlchemy,
      Flask-Migrate for schema changes, and a shared base template for consistent styling.
    </p>
    <footer class="meta empty">
      <em>Try the Home page to see a fresh quote.</em>
    </footer>
  </section>
{% endblock %}
```

### flaskapp/templates/index.html

This is your “Comment of the Day” page—same visual design, now plugged into base.html.

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Comment of the Day</title>

    <!-- Optional: nice font -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Our styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/quotes.css') }}">
  </head>
  <body>
    <main class="wrap">
      <section class="quote-card" role="article" aria-label="Comment of the Day">
        <div class="badge">Comment of the Day</div>

        <blockquote class="quote">
          <div class="quote-mark" aria-hidden="true">“</div>
          <p class="quote-text"><br>{{ quote }}</p>
          <div class="quote-mark end" aria-hidden="true">”</div>
        </blockquote>

        {% if author %}
        <footer class="meta">
          <div class="avatar" aria-hidden="true">
            {{ author.split()[0][0] if author else 'C' }}
          </div>
          <div class="byline">
            <span class="label">by</span>
            <span class="author">{{ author }}</span>
          </div>

          <button class="btn ghost copy" type="button" data-copy="{{ quote }}{% if author %} — {{ author }}{% endif %}">
            Copy
          </button>
        </footer>
        {% else %}
        <footer class="meta empty">
          <em>Add quotes with <code>flask seed-quotes</code></em>
        </footer>
        {% endif %}
      </section>

      <button class="btn primary" onclick="location.reload()">Show another</button>
    </main>

    <script>
      // Copy-to-clipboard
      document.addEventListener('click', (e) => {
        const btn = e.target.closest('.copy');
        if (!btn) return;
        const text = btn.getAttribute('data-copy');
        navigator.clipboard.writeText(text).then(() => {
          const original = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => (btn.textContent = original), 1100);
        });
      });
    </script>
  </body>
</html>
```

### flaskapp/static/css/quotes.css

```css
::root{
  --bg: #0b1020;
  --fg: #e8edf7;
  --muted: #a6b1c4;
  --card: #121936;
  --card-2: #0f1530;
  --accent: #8aa9ff;
  --accent-2: #9ef3ff;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

@media (prefers-color-scheme: light){
  :root{
    --bg: #f7f9ff;
    --fg: #1c2333;
    --muted: #58627a;
    --card: #ffffff;
    --card-2: #f2f6ff;
    --accent: #3a66ff;
    --accent-2: #5dd6ff;
    --shadow: 0 10px 24px rgba(24,32,56,.12);
  }
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body{
  margin:0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color: var(--fg);
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(138,169,255,.18), transparent 60%),
    radial-gradient(900px 500px at 110% 10%, rgba(158,243,255,.18), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg));
  display: grid;
  place-items: center;
  padding: 2rem;
}

.wrap{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap: 1.25rem;
  width: min(800px, 100%);
}

.quote-card{
  width: 100%;
  background: linear-gradient(180deg, var(--card), var(--card-2));
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 24px;
  padding: clamp(1.25rem, 3vw, 2rem);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  isolation: isolate;
  transform: translateZ(0); /* enables smoother animation */
  animation: pop-in .5s cubic-bezier(.2,.8,.2,1) both;
}

.badge{
  position: absolute;
  top: 12px; left: 12px;
  font-size: .75rem;
  letter-spacing: .06em;
  text-transform: uppercase;
  color: var(--muted);
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.08);
  padding: .35rem .55rem;
  border-radius: 999px;
  backdrop-filter: blur(6px);
}

.quote{
  margin: 0 0 1rem 0;
  position: relative;
}

.quote-text{
  font-size: clamp(1.3rem, 2.8vw, 1.85rem);
  line-height: 1.5;
  font-weight: 600;
  letter-spacing: .01em;
}

.quote-mark{
  position: absolute;
  top: -.5rem; left: -.25rem;
  font-size: clamp(3rem, 8vw, 5rem);
  line-height: 1;
  color: transparent;
  -webkit-text-stroke: 1px rgba(255,255,255,.16);
  text-shadow: 0 10px 40px rgba(0,0,0,.25);
  transform: translateY(-10px) rotate(-2deg);
  user-select: none;
  pointer-events: none;
}
.quote-mark.end{
  position: static;
  display: inline-block;
  margin-left: .25ch;
  transform: translateY(.25ch) rotate(1deg);
  -webkit-text-stroke: 0;
  color: rgba(255,255,255,.25);
}

.meta{
  display: flex;
  align-items: center;
  gap: .75rem;
  margin-top: .5rem;
}

.meta.empty{
  color: var(--muted);
}

.avatar{
  width: 36px; height: 36px;
  border-radius: 50%;
  display:grid; place-items:center;
  font-weight: 700;
  background: radial-gradient(circle at 30% 30%, var(--accent-2), var(--accent));
  color: #0b1020;
  text-transform: uppercase;
  letter-spacing: .02em;
  box-shadow: 0 6px 16px rgba(0,0,0,.25);
}

.byline .label{
  color: var(--muted);
  font-size: .85rem;
  margin-right: .35rem;
}
.byline .author{
  font-weight: 600;
}

.btn{
  appearance: none;
  border: 0;
  border-radius: 999px;
  padding: .65rem 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform .06s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  box-shadow: 0 8px 20px rgba(0,0,0,.18);
}

.btn.primary{
  background: linear-gradient(180deg, var(--accent-2), var(--accent));
  color: #0b1020;
}
.btn.primary:hover{ transform: translateY(-1px); }
.btn.primary:active{ transform: translateY(0); }

.btn.ghost{
  background: transparent;
  color: var(--fg);
  border: 1px solid rgba(255,255,255,.15);
  padding: .5rem .85rem;
  box-shadow: none;
}
.btn.ghost:hover{
  background: rgba(255,255,255,.08);
}

@keyframes pop-in{
  from{ opacity: 0; transform: translateY(6px); }
  to  { opacity: 1; transform: translateY(0); }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce){
  * { animation: none !important; transition: none !important; }
}

.site-header, .site-footer{
  width: 100%;
  max-width: 1000px;
  margin: 0 auto 1rem;
  color: var(--muted);
}
.nav{
  display:flex; align-items:center; gap:1rem;
  padding: .5rem 0 1rem;
}
.brand{ font-weight: 800; text-decoration:none; color: var(--fg); }
.nav .spacer{ flex:1; }
.nav-link{
  text-decoration:none; color: var(--muted);
  padding: .35rem .6rem; border-radius: 8px;
}
.nav-link.active, .nav-link:hover{
  color: var(--fg);
  background: rgba(255,255,255,.08);
}
.site-footer{ text-align:center; margin-top: 2rem; }
```

## 10) Initialize Flask-Migrate & create the migration

From your project root (where FLASK_APP=yourapp resolves to this package):

```bash
# one-time: set env vars for local dev
export FLASK_APP=yourapp
export FLASK_DEBUG=1

# 1) initialize Alembic (creates migrations/ folder)
flask db init

# 2) generate initial migration from models.py
flask db migrate -m "create quotes table"

# 3) apply it to the configured DB
flask db upgrade

# 4) optional: seed some data
flask seed-quotes
```

## 11) Testing (pytest)

.env.test (loaded in tests if you call dotenv.load_dotenv('.env.test')):

```ini
FLASK_ENV_NAME=testing
TEST_DATABASE_URL=sqlite:///:memory:
```

tests/conftest.py:

```python
# tests/conftest.py (snippet)
import os
import pytest
from flaskapp import create_app
from dotenv import load_dotenv
from flaskapp import create_app
from flaskapp.extensions import db
from flaskapp.models import Quote

@pytest.fixture(scope="session")
def app():
  load_dotenv(".env.test")
  app = create_app("testing")
  with app.app_context():
    db.create_all()
    yield app
    db.session.remove()
    db.drop_all()

@pytest.fixture()
def client(app):
  return app.test_client()
```

tests/test_home.py

```python
# tests/test_home.py
import pytest
from flask import template_rendered
from dotenv import load_dotenv
from flaskapp import db, Quote


# If your package is named `yourapp` and exposes create_app in __init__.py:
from flaskapp import create_app
from tests.conftest import captured_templates

# overload the app fixture to pre-populate the database
@pytest.fixture(scope="session")
def app():
  load_dotenv(".env.test")
  app = create_app("testing")
  with app.app_context():
    db.create_all()
    db.session.add(Quote(text="Test quote", author="Tester"))
    db.session.commit()
    yield app
    db.session.remove()
    db.drop_all()


def test_home_status_and_content(client):
    """GET / returns 200 and expected content from the homepage template."""
    resp = client.get("/")
    assert resp.status_code == 200
    # Adjust the expected bytes below if your template text differs.
    assert b"Test quote" in resp.data


def test_home_uses_index_template(app, client):
    """The home view renders index.html."""
    with captured_templates(app) as templates:
        _ = client.get("/")
        assert len(templates) == 1
        template, context = templates[0]
        assert template.name == "index.html"


def test_home_route_is_registered(app):
    """The blueprint is mounted at root with '/' -> endpoint 'routes.home'."""
    # The endpoint name is <blueprint_name>.<view_func_name>
    endpoints = {(r.rule, r.endpoint) for r in app.url_map.iter_rules()}
    assert ("/", "routes.home") in endpoints
```

tests/test_db.py

```python
# tests/test_db.py
from flaskapp import Quote, db
import pytest

def test_db_is_empty(session):
    """Database starts empty."""
    count = session.query(Quote).count()
    assert count == 0

def test_add_quote(session):
    """Can insert a quote into the database."""
    q = Quote(text="Testing is essential.", author="QA Bot")
    session.add(q)
    session.commit()

    stored = Quote.query.first()
    assert stored is not None
    assert stored.text == "Testing is essential."
    assert stored.author == "QA Bot"

def test_multiple_quotes_and_random(session):
    """Can store multiple quotes and select randomly."""
    quotes = [
        Quote(text="One", author="A"),
        Quote(text="Two", author="B"),
        Quote(text="Three", author="C"),
    ]
    session.add_all(quotes)
    session.commit()

    all_quotes = Quote.query.all()
    assert len(all_quotes) == 4  # 1 from test_add_quote + 3 new

    # Using SQLAlchemy func.random() to simulate random selection
    from sqlalchemy import func
    random_quote = Quote.query.order_by(func.random()).first()
    assert isinstance(random_quote, Quote)
    assert random_quote.text in {q.text for q in all_quotes}
```

## 12) Environment selection

### Development (local)

.env (auto-loaded by flask run via python-dotenv):

```ini
FLASK_APP=wsgi.py
FLASK_DEBUG=1
FLASK_ENV_NAME=development
DEV_DATABASE_URL=sqlite:///dev.db
SECRET_KEY=dev-only
```

Run:

```bash
flask run
```

or

```bash
python -m flask run
```

### Production

Set real environment variables at deploy time (no .env files):

```ini
export FLASK_ENV_NAME=production
export SECRET_KEY='super-long-random-string'
export DATABASE_URL='postgresql+psycopg://user:pass@host/db'
export LOG_LEVEL=INFO
```

WSGI entry (wsgi.py):

```python
from yourapp import create_app
app = create_app()  # picks up FLASK_ENV_NAME
```

Example gunicorn command:

```bash
gunicorn "wsgi:app" --bind 0.0.0.0:8000 --workers 3
```


## 13) Common gotchas & tips

- **Secrets:** never commit real SECRET_KEY or credentials. In prod, force them via os.environ["..."] to fail fast if missing.

- **Debug vs. Config:** FLASK_DEBUG=1 toggles debugger/reloader; it does not choose your database or other settings—your config class does.

- **Testing DB:** use sqlite:///:memory: or a throwaway Postgres DB per test session; create/drop schema in fixtures as needed.

- **Overrides order (later wins):**

1. Config class
2. instance/config.py
3. YOURAPP_SETTINGS file
4. app.config.from_mapping(...) if you add it

- **Logging:** tune per env (e.g., JSON logs in prod, DEBUG in dev).

- **Extensions:** initialize inside create_app so they respect the chosen config.
